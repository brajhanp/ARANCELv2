{% extends 'base.html' %}
{% block content %}
<div class="mb-3">
    <a href="{% url 'central:home' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
    </a>
</div>

<!DOCTYPE html>
<html>
<head>
    <title>Tabla de Aranceles</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .seccion {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        .header-row {
            background-color: #e0e0e0;
        }
        .subheader-row {
            background-color: #f0f0f0;
        }
        .text-left {
            text-align: left;
        }
        .small-text {
            font-size: 12px;
        }
        .resaltado-busqueda {
            background-color: #fff3b0 !important;
            transition: background-color 0.5s;
        }
        .resaltado-palabra {
            background-color: #ffe066 !important;
            color: #000;
            border-radius: 3px;
            padding: 0 2px;
        }
        .resaltado-busqueda-tabla {
            background-color: rgba(255, 0, 0, 0.2) !important;
            transition: background-color 0.3s ease;
        }
        .fila-oculta {
            display: none !important;
        }
        #sugerencias-dropdown {
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }
        #sugerencias-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        #sugerencias-dropdown::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        #sugerencias-dropdown::-webkit-scrollbar-thumb {
            background-color: #6c757d;
            border-radius: 4px;
        }
        #sugerencias-dropdown::-webkit-scrollbar-thumb:hover {
            background-color: #495057;
        }
        #sugerencias-dropdown .list-group-item {
            border-left: none;
            border-right: none;
            padding: 0.75rem 1rem;
        }
        #sugerencias-dropdown .list-group-item:hover {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Referencias de Clasificaci贸n</h1>
        <!--  Bot贸n de copiar -->
        <button id="copiar-aranceles" class="btn btn-outline-primary">
            <i class="fas fa-copy me-2"></i>Copiar Aranceles
        </button>
    </div>

    <!--  Campo de b煤squeda -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex gap-2">
                <div class="flex-grow-1 position-relative">
                    <input 
                        class="form-control form-control-lg" 
                        type="search" 
                        id="busqueda-tabla" 
                        placeholder="Buscar en esta tabla por c贸digo o descripci贸n..." 
                        aria-label="Buscar"
                        autocomplete="off"
                    >
                    <!-- Dropdown de sugerencias -->
                    <ul id="sugerencias-dropdown" class="list-group position-absolute w-100 mt-1" style="z-index: 9999; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; background-color: white;" role="listbox"></ul>
                </div>
                <button id="btn-limpiar-busqueda" class="btn btn-outline-secondary btn-lg" style="display: none;">
                    <i class="fas fa-times me-2"></i>Limpiar
                </button>
            </div>
            <div id="info-busqueda" class="mt-2" style="display: none;">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    <span id="texto-busqueda"></span>
                </small>
            </div>
        </div>
    </div>

    {% load custom_filters %}

    <!--  Contenedor para copiar -->
    <div id="tabla-aranceles">
        {% for seccion in secciones %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Secci贸n {{ seccion.id }}: {{ seccion.nombre|replace_none }}
                </h5>
                {% if seccion.descripcion %}
                <small>{{ seccion.descripcion|replace_none }}</small>
                {% endif %}
            </div>
            <div class="card-body">
                {% for capitulo in seccion.capitulos.all %}
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-book me-2"></i>
                            Cap铆tulo {{ capitulo.codigo }}: {{ capitulo.nombre|replace_none }}
                        </h6>
                        {% if capitulo.descripcion %}
                        <small>{{ capitulo.descripcion|replace_none }}</small>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% for partida in capitulo.partidas.all %}
                        <div class="card mb-2">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ol me-2"></i>
                                    Partida {{ partida.codigo }}: {{ partida.descripcion|replace_none }}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>C贸digo</th>
                                                <th>Descripci贸n de la mercanc铆a</th>
                                                <th>GA %</th>
                                                <th>ICE - IEHD</th>
                                                <th>Unidad de Medida</th>
                                                <th>Despacho en Frontera</th>
                                                <th>Tipo de Doc</th>
                                                <th>Entidad que emite</th>
                                                <th>Disp. Legal</th>
                                                <th>CAN ACE 36 ACE 47 VEN</th>
                                                <th>ACE 22 Chi</th>
                                                <th>ACE 22 Prot</th>
                                                <th>ACE 66 MXICO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for subpartida in partida.subpartidas.all %}
                                                {% if subpartida.codigo|is_descriptive_code %}
                                                    <tr class="table-primary">
                                                        <td colspan="13" class="text-center">
                                                            <strong>{{ subpartida.descripcion|replace_none }}</strong>
                                                        </td>
                                                    </tr>
                                                {% else %}
                                                    <tr id="subpartida-{{ subpartida.id }}">
                                                        <td><strong>{{ subpartida.codigo|replace_none }}</strong></td>
                                                        <td>{{ subpartida.descripcion|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.ga|replace_none }}</td>
                                                        <td>{{ subpartida.ice_iehd|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.unidad_medida|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.despacho_en_frontera|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.tipo_de_doc|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.entidad_que_emite|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.disposicion_legal|replace_none|underscore_to_space }}</td>
                                                        <td>{{ subpartida.can_ace_36_47_ven|replace_none }}</td>
                                                        <td>{{ subpartida.ace_22_chile|replace_none }}</td>
                                                        <td>{{ subpartida.ace_22_prot|replace_none }}</td>
                                                        <td>{{ subpartida.ace_66_mexico|replace_none }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
    //  B煤squeda en la tabla actual (solo en esta p谩gina)
    const inputTabla = document.getElementById("busqueda-tabla");
    const btnLimpiar = document.getElementById("btn-limpiar-busqueda");
    const infoBusqueda = document.getElementById("info-busqueda");
    const textoBusqueda = document.getElementById("texto-busqueda");
    
    if (inputTabla) {
        // Funci贸n para limpiar resaltados
        function limpiarResaltados() {
            // Remover todas las clases de resaltado
            document.querySelectorAll('.resaltado-busqueda-tabla').forEach(el => {
                el.classList.remove('resaltado-busqueda-tabla');
            });
            // Mostrar todas las filas
            document.querySelectorAll('.fila-oculta').forEach(el => {
                el.classList.remove('fila-oculta');
            });
            // Ocultar bot贸n limpiar e info
            btnLimpiar.style.display = 'none';
            infoBusqueda.style.display = 'none';
        }
        
        // Funci贸n para buscar y resaltar
        function buscarEnTabla(termino, scrollToFirst = false) {
            if (!termino || termino.trim() === '') {
                limpiarResaltados();
                return null;
            }
            
            const terminoLower = termino.toLowerCase().trim();
            let coincidencias = 0;
            let primeraCoincidencia = null;
            
            // Primero limpiar resaltados anteriores
            limpiarResaltados();
            
            // Buscar en todas las filas de la tabla
            const filas = document.querySelectorAll('#tabla-aranceles tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent || fila.innerText || '';
                const textoLower = texto.toLowerCase();
                const tieneCoincidencia = textoLower.includes(terminoLower);
                
                // Si es una fila de encabezado o descriptiva, siempre mostrarla
                const esEncabezado = fila.querySelector('th') !== null;
                const esDescriptiva = fila.classList.contains('table-primary');
                
                if (tieneCoincidencia) {
                    // Resaltar la fila completa
                    fila.classList.add('resaltado-busqueda-tabla');
                    fila.classList.remove('fila-oculta');
                    coincidencias++;
                    
                    // Guardar la primera coincidencia para scroll
                    if (!primeraCoincidencia && !esEncabezado) {
                        primeraCoincidencia = fila;
                    }
                    
                    // Tambi茅n resaltar las celdas individuales que contienen el t茅rmino
                    const celdas = fila.querySelectorAll('td, th');
                    celdas.forEach(celda => {
                        const textoCelda = celda.textContent || '';
                        if (textoCelda.toLowerCase().includes(terminoLower)) {
                            celda.classList.add('resaltado-busqueda-tabla');
                        }
                    });
                } else {
                    // NO ocultar las filas, solo quitar el resaltado si lo ten铆a
                    fila.classList.remove('resaltado-busqueda-tabla');
                    fila.classList.remove('fila-oculta');
                }
            });
            
            // Mostrar informaci贸n de b煤squeda
            if (coincidencias > 0) {
                textoBusqueda.textContent = `Encontradas ${coincidencias} coincidencia(s) para: "${termino}"`;
                infoBusqueda.style.display = 'block';
                btnLimpiar.style.display = 'block';
                
                // Scroll a la primera coincidencia si se solicita
                if (scrollToFirst && primeraCoincidencia) {
                    setTimeout(() => {
                        primeraCoincidencia.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        // Resaltar adicionalmente la primera coincidencia
                        primeraCoincidencia.style.boxShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
                        setTimeout(() => {
                            primeraCoincidencia.style.boxShadow = '';
                        }, 2000);
                    }, 100);
                }
            } else {
                textoBusqueda.textContent = `No se encontraron coincidencias para: "${termino}"`;
                infoBusqueda.style.display = 'block';
                btnLimpiar.style.display = 'block';
            }
            
            return primeraCoincidencia;
        }
        
        // Referencia al dropdown de sugerencias
        const sugerenciasDropdown = document.getElementById("sugerencias-dropdown");
        
        // Funci贸n para obtener sugerencias del servidor con correcci贸n ortogr谩fica
        function obtenerSugerencias(termino) {
            if (!termino || termino.trim().length < 1) {
                sugerenciasDropdown.style.display = 'none';
                return;
            }
            
            fetch('/arancel/autocomplete/?q=' + encodeURIComponent(termino))
                .then(resp => resp.json())
                .then(data => {
                    sugerenciasDropdown.innerHTML = '';
                    
                    if (data.length === 0) {
                        const li = document.createElement('li');
                        li.className = 'list-group-item text-center text-muted py-3';
                        li.innerHTML = '<i class="fas fa-search me-2"></i>No se encontraron coincidencias';
                        sugerenciasDropdown.appendChild(li);
                        sugerenciasDropdown.style.display = 'block';
                        return;
                    }
                    
                    // Mostrar m谩ximo 10 sugerencias
                    data.slice(0, 10).forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item list-group-item-action';
                        li.style.cursor = 'pointer';
                        li.setAttribute('role', 'option');
                        li.setAttribute('data-tipo', item.tipo);
                        li.setAttribute('data-id', item.id);
                        li.setAttribute('data-codigo', item.codigo || '');
                        
                        let contenido = '';
                        let badgeClass = '';
                        
                        if (item.tipo === 'Partida') {
                            badgeClass = 'bg-warning text-dark';
                            contenido = `<span class="badge ${badgeClass} me-2">Partida</span><strong>${item.codigo}</strong> - ${(item.descripcion || '').substring(0, 60)}${(item.descripcion || '').length > 60 ? '...' : ''}`;
                        } else if (item.tipo === 'Subpartida') {
                            badgeClass = 'bg-info';
                            contenido = `<span class="badge ${badgeClass} me-2">Subpartida</span><strong>${item.codigo}</strong> - ${(item.descripcion || '').substring(0, 60)}${(item.descripcion || '').length > 60 ? '...' : ''}`;
                        } else if (item.tipo === 'Cap铆tulo') {
                            badgeClass = 'bg-success';
                            contenido = `<span class="badge ${badgeClass} me-2">Cap铆tulo</span><strong>${item.codigo}</strong> - ${item.nombre || ''}`;
                        }
                        
                        li.innerHTML = contenido;
                        
                        // Efecto hover
                        li.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = '#f8f9fa';
                        });
                        li.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        // Al hacer click, buscar en la tabla y hacer scroll
                        li.addEventListener('click', function() {
                            const codigo = this.getAttribute('data-codigo');
                            const descripcion = this.textContent || '';
                            inputTabla.value = codigo;
                            sugerenciasDropdown.style.display = 'none';
                            
                            // Buscar en la tabla con el c贸digo
                            buscarEnTabla(codigo, false);
                            
                            // Esperar un momento para que se apliquen los resaltados, luego hacer scroll
                            setTimeout(() => {
                                // Buscar la primera fila resaltada
                                const filasResaltadas = document.querySelectorAll('#tabla-aranceles tr.resaltado-busqueda-tabla');
                                if (filasResaltadas.length > 0) {
                                    const primeraFila = filasResaltadas[0];
                                    primeraFila.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'center' 
                                    });
                                    // Resaltar adicionalmente con sombra
                                    primeraFila.style.boxShadow = '0 0 15px rgba(255, 0, 0, 0.6)';
                                    setTimeout(() => {
                                        primeraFila.style.boxShadow = '';
                                    }, 2000);
                                }
                            }, 100);
                        });
                        
                        sugerenciasDropdown.appendChild(li);
                    });
                    
                    sugerenciasDropdown.style.display = 'block';
                })
                .catch(err => {
                    console.error('Error al obtener sugerencias:', err);
                });
        }
        
        // Event listener para el input
        let timeoutId;
        let timeoutSugerencias;
        inputTabla.addEventListener("input", function() {
            clearTimeout(timeoutId);
            clearTimeout(timeoutSugerencias);
            const valor = this.value;
            
            // Obtener sugerencias del servidor (con correcci贸n ortogr谩fica)
            timeoutSugerencias = setTimeout(() => {
                obtenerSugerencias(valor);
            }, 200);
            
            // Buscar en la tabla local (debounce: esperar 300ms)
            timeoutId = setTimeout(() => {
                buscarEnTabla(valor, false);
            }, 300);
        });
        
        // Ocultar sugerencias al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!inputTabla.contains(e.target) && !sugerenciasDropdown.contains(e.target)) {
                sugerenciasDropdown.style.display = 'none';
            }
        });
        
        // Al presionar Enter, buscar y hacer scroll a la primera coincidencia
        inputTabla.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const valor = this.value.trim();
                if (valor) {
                    buscarEnTabla(valor, true); // true = hacer scroll a la primera coincidencia
                }
            } else if (e.key === 'Escape') {
                inputTabla.value = '';
                limpiarResaltados();
            }
        });
        
        // Bot贸n limpiar
        btnLimpiar.addEventListener('click', function() {
            inputTabla.value = '';
            limpiarResaltados();
            sugerenciasDropdown.style.display = 'none';
            inputTabla.focus();
        });
    }
    
    //  Bot贸n para copiar aranceles
    document.getElementById("copiar-aranceles")?.addEventListener("click", async () => {
        try {
            const tabla = document.querySelector("#tabla-aranceles");
            const contenido = tabla ? tabla.innerText : "No hay aranceles visibles.";

            await navigator.clipboard.writeText(contenido);

            const boton = document.getElementById("copiar-aranceles");
            const original = boton.innerHTML;
            boton.innerHTML = '<i class="fas fa-check me-2"></i>隆Copiado!';
            boton.classList.remove('btn-outline-primary');
            boton.classList.add('btn-success');
            
            setTimeout(() => {
                boton.innerHTML = original;
                boton.classList.remove('btn-success');
                boton.classList.add('btn-outline-primary');
            }, 2000);
        } catch (err) {
            alert("Error al copiar: " + err);
        }
    });

    </script>
</body>
</html>
{% endblock %}
