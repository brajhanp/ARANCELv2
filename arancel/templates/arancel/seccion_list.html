{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="mb-3">
    <a href="{% url 'central:home' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
    </a>
</div>

<div class="row mb-4">
    <div class="col">
        <h2 class="mb-4">
            <i class="fas fa-layer-group me-2"></i>
            Lista de Secciones
        </h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8 position-relative mx-auto">
        <form class="d-flex" method="get">
            <input class="form-control me-2" type="search" id="busqueda-seccion" name="q" placeholder="Buscar código o descripción..." aria-label="Buscar" autocomplete="off">
            <button class="search-btn-custom" type="submit"><i class="fas fa-arrow-right"></i></button>
        </form>
        <ul id="sugerencias-seccion" class="list-group position-absolute w-100" style="z-index: 1000;"></ul>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for seccion in secciones %}
                    <tr>
                        <td>{{ seccion.id }}</td>
                        <td>{{ seccion.nombre|replace_none }}</td>
                        <td>{{ seccion.descripcion|replace_none }}</td>
                        <td>
                            <a href="{% url 'arancel:seccion_detail' seccion.id %}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay secciones registradas.
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Autocompletado AJAX para secciones
const inputSeccion = document.getElementById('busqueda-seccion');
const sugerenciasSeccion = document.getElementById('sugerencias-seccion');
const formSeccion = document.querySelector('form.d-flex');
if(inputSeccion) {
    inputSeccion.addEventListener('input', function() {
        const valor = this.value.trim();
        if (valor.length < 2) {
            sugerenciasSeccion.innerHTML = '';
            sugerenciasSeccion.style.display = 'none';
            return;
        }
        fetch('/arancel/autocomplete/?q=' + encodeURIComponent(valor))
            .then(resp => resp.json())
            .then(data => {
                sugerenciasSeccion.innerHTML = '';
                if (data.length === 0) {
                    // Mostrar mensaje de "No se encontró nada"
                    const li = document.createElement('li');
                    li.className = 'list-group-item text-center text-muted';
                    li.innerHTML = '<i class="fas fa-search me-2"></i>No se encontró nada';
                    sugerenciasSeccion.appendChild(li);
                    sugerenciasSeccion.style.display = 'block';
                    return;
                }
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action d-flex align-items-center';
                    
                    // Crear badge de tipo con color distintivo
                    const badge = document.createElement('span');
                    badge.className = 'badge me-2';
                    
                    if (item.tipo === 'Partida') {
                        badge.className += ' bg-warning';
                        badge.innerHTML = '<i class="fas fa-list-ol me-1"></i>Partida';
                    } else if (item.tipo === 'Subpartida') {
                        badge.className += ' bg-info';
                        badge.innerHTML = '<i class="fas fa-table me-1"></i>Subpartida';
                    } else if (item.tipo === 'Capítulo') {
                        badge.className += ' bg-success';
                        badge.innerHTML = '<i class="fas fa-book me-1"></i>Capítulo';
                    } else if (item.tipo === 'Sección') {
                        badge.className += ' bg-primary';
                        badge.innerHTML = '<i class="fas fa-layer-group me-1"></i>Sección';
                    }
                    
                    li.appendChild(badge);
                    
                    // Crear contenido del texto
                    const content = document.createElement('div');
                    content.className = 'flex-grow-1';
                    content.innerHTML = `<strong>${item.codigo || item.nombre}</strong> - ${item.descripcion || ''}`;
                    li.appendChild(content);
                    
                    if(item.tipo === 'Sección') {
                        li.onclick = () => {
                            window.location.href = `/arancel/secciones/${item.id}/`;
                        };
                    } else if(item.tipo === 'Capítulo') {
                        li.onclick = () => {
                            window.location.href = `/arancel/capitulos/${item.id}/`;
                        };
                    } else if(item.tipo === 'Partida') {
                        li.onclick = () => {
                            window.location.href = `/arancel/partidas/${item.id}/`;
                        };
                    } else if(item.tipo === 'Subpartida') {
                        li.onclick = () => {
                            window.location.href = `/arancel/subpartidas/${item.id}/`;
                        };
                    }
                    sugerenciasSeccion.appendChild(li);
                });
                sugerenciasSeccion.style.display = 'block';
            });
    });
    inputSeccion.addEventListener('blur', function() {
        setTimeout(() => { sugerenciasSeccion.innerHTML = ''; sugerenciasSeccion.style.display = 'none'; }, 200);
    });
}

if(formSeccion && inputSeccion) {
    formSeccion.addEventListener('submit', function(e) {
        e.preventDefault();
        const valor = inputSeccion.value.trim();
        if (valor.length < 1) {
            formSeccion.submit();
            return;
        }
        fetch('/arancel/autocomplete/?q=' + encodeURIComponent(valor))
            .then(resp => resp.json())
            .then(data => {
                // Buscar coincidencia exacta con sección, capítulo, partida o subpartida
                let encontrado = false;
                data.forEach(item => {
                    if(item.tipo === 'Sección' && (item.nombre.toLowerCase() === valor.toLowerCase())) {
                        window.location.href = `/arancel/secciones/${item.id}/`;
                        encontrado = true;
                    } else if(item.tipo === 'Capítulo' && (item.codigo.toLowerCase() === valor.toLowerCase() || item.nombre.toLowerCase() === valor.toLowerCase() || (`${item.codigo} - ${item.nombre}`).toLowerCase() === valor.toLowerCase())) {
                        window.location.href = `/arancel/capitulos/${item.id}/`;
                        encontrado = true;
                    } else if(item.tipo === 'Partida' && (item.codigo.toLowerCase() === valor.toLowerCase())) {
                        window.location.href = `/arancel/partidas/${item.id}/`;
                        encontrado = true;
                    } else if(item.tipo === 'Subpartida' && (item.codigo.toLowerCase() === valor.toLowerCase())) {
                        window.location.href = `/arancel/subpartidas/${item.id}/`;
                        encontrado = true;
                    }
                });
                if(!encontrado) formSeccion.submit();
            });
    });
}
</script>
{% endblock %} 